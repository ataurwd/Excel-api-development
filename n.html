<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google Sheet Data Table</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">
  <h1 class="text-3xl font-bold mb-6 text-gray-800">Live Google Sheet Data</h1>

  <!-- Loading -->
  <div id="loading" class="text-center py-6 text-gray-600 font-medium">
    Loading data...
  </div>

  <!-- Table wrapper -->
  <div id="table-wrapper" class="overflow-x-auto bg-white rounded-xl shadow-lg hidden">
    <table class="min-w-full border border-gray-200">
      <thead class="bg-gray-50" id="table-head"></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div id="pagination" class="flex flex-wrap gap-2 mt-4 justify-center"></div>

  <script>
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzgypNxRUcd7HswtmD61DUSKvcMykrzx4bK-LcOuc2iSRxdNsl8j7KF6IAb4IKRkvnlZc0L7BbuHrO/pub?gid=1877949697&single=true&output=csv";

    const ROWS_PER_PAGE = 20;
    let currentPage = 1;
    let headers = [];
    let allRows = [];           // All data from CSV
    let symbolColumnName = "";
    let urlColumns = [];

    function parseCSV(csvText) {
      const lines = csvText.trim().split("\n");
      headers = lines[0].split(",").map(h => h.trim().replace(/\r/g, ''));

      // Detect symbol column
      symbolColumnName = headers.find(h =>
        h.toLowerCase().includes("symbol") || h.toLowerCase().includes("shares")
      ) || "";

      // Detect URL columns
      urlColumns = headers.filter(h => h.toLowerCase().includes("url"));

      // Store all rows as objects
      allRows = lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = values[i]?.trim().replace(/\r/g, '') || "";
        });
        return obj;
      });
    }

    // This function renders only the current page's 20 rows
    function renderCurrentPage() {
      const start = (currentPage - 1) * ROWS_PER_PAGE;
      const end = start + ROWS_PER_PAGE;
      const paginatedRows = allRows.slice(start, end);

      // Visible headers: exclude symbol column and keep only last URL column
      let visibleHeaders = headers.filter(h => h !== symbolColumnName);

      if (urlColumns.length > 0) {
        const lastUrl = urlColumns[urlColumns.length - 1];
        visibleHeaders = visibleHeaders.filter(h => !urlColumns.includes(h) || h === lastUrl);
      }

      // Header row
      const headHTML = `
        <tr>
          <th class="px-4 py-2 text-left text-sm font-semibold bg-[#F9FAFB]">#</th>
          ${visibleHeaders
            .map(h =>
              h.toLowerCase() === "name"
                ? `<th class="px-4 py-2 text-left text-sm font-semibold">Name & Symbol</th>`
                : `<th class="px-4 py-2 text-left text-sm font-semibold">${h}</th>`
            )
            .join("")}
        </tr>
      `;
      document.getElementById("table-head").innerHTML = headHTML;

      // Body rows (only current page)
      const bodyHTML = paginatedRows
        .map((row, index) => {
          const rowNumber = start + index + 1;
          const symbol = row[symbolColumnName] || "";

          return `
            <tr class="hover:bg-gray-50 transition border">
              <td class="px-4 py-2 text-sm text-gray-600">${rowNumber}</td>
              ${visibleHeaders
                .map(h => {
                  const value = row[h] || "";
                  if (h.toLowerCase() === "name") {
                    return `<td class="px-4 py-2 text-sm text-gray-700 font-medium">
                              <div>${value}</div>
                              <div class="text-gray-500 text-xs">${symbol}</div>
                            </td>`;
                  } else {
                    return `<td class="px-4 py-2 text-sm text-gray-600">
                              <div>${value}</div>
                            </td>`;
                  }
                })
                .join("")}
            </tr>
          `;
        })
        .join("");

      document.getElementById("table-body").innerHTML = bodyHTML;
    }

    function renderPagination() {
      const totalPages = Math.ceil(allRows.length / ROWS_PER_PAGE);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      if (totalPages <= 1) return; // No pagination needed

      const windowSize = 5;
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + windowSize - 1);
      startPage = Math.max(1, endPage - windowSize + 1);

      if (currentPage > 1) {
        pagination.innerHTML += `
          <button onclick="goToPage(${currentPage - 1})" class="px-3 py-1 border rounded bg-white hover:bg-gray-100">Prev</button>
        `;
      }

      for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `
          <button
            onclick="goToPage(${i})"
            class="px-3 py-1 border rounded ${
              i === currentPage ? "bg-blue-600 text-white" : "bg-white hover:bg-gray-100"
            }"
          >
            ${i}
          </button>
        `;
      }

      if (currentPage < totalPages) {
        pagination.innerHTML += `
          <button onclick="goToPage(${currentPage + 1})" class="px-3 py-1 border rounded bg-white hover:bg-gray-100">Next</button>
        `;
      }
    }

    function goToPage(page) {
      currentPage = page;
      renderCurrentPage();     // Only render the 20 rows for this page
      renderPagination();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Initial load
    fetch(CSV_URL)
      .then(res => res.text())
      .then(csv => {
        parseCSV(csv);

        // Hide loading, show table
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("table-wrapper").classList.remove("hidden");

        // Render first page (20 rows) immediately
        renderCurrentPage();
        renderPagination();
      })
      .catch(err => {
        console.error(err);
        document.getElementById("loading").innerHTML =
          `<span class="text-red-600">Failed to load data</span>`;
      });
  </script>
</body>
</html>